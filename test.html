<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoneCloud with Captcha Verification (Fixed)</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Raleway:wght@600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    <style>
        :root {
            --nc-purple: #8A2BE2;
            --nc-cyan: #00D1FF;
            --nc-dark-bg: #0D0E14;
            --nc-surface: #1A1B24;
            --background-color: var(--nc-dark-bg);
            --default-color: #E0E0E0;
            --heading-color: #ffffff;
            --accent-color: var(--nc-purple);
            --surface-color: var(--nc-surface);
            --default-font: "Roboto", sans-serif;
            --heading-font: "Raleway", sans-serif;
        }

        body {
            background-color: var(--background-color);
            font-family: var(--default-font);
            color: var(--default-color);
        }

        .popup-hidden { display: none; }

        #legal-popup-overlay {
            position: fixed; inset: 0;
            background: rgba(13, 14, 20, 0.7);
            backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            z-index: 10000; transition: opacity 0.3s ease-in-out;
        }

        #legal-popup {
            background: var(--nc-surface);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            min-height: 300px; /* Adjusted for better spacing */
            overflow: hidden;
            border: 1px solid color-mix(in srgb, var(--nc-purple), transparent 80%);
            animation: popup-fade-in 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
        }
        
        @keyframes popup-fade-in {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* This is the main container that will be changed dynamically */
        #popup-dynamic-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        
        .popup-header {
            padding: 24px 30px;
            border-bottom: 1px solid color-mix(in srgb, var(--default-color), transparent 90%);
        }

        .popup-header h2 {
            margin: 0; font-family: var(--heading-font); font-size: 1.5rem; font-weight: 700;
            background: linear-gradient(135deg, var(--nc-purple) 0%, var(--nc-cyan) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        .popup-content { padding: 24px 30px; line-height: 1.7; flex-grow: 1; }
        .popup-content p { margin: 0; }
        .popup-content a { color: var(--nc-cyan); text-decoration: none; font-weight: 500; }

        .popup-actions {
            padding: 20px 30px;
            background: color-mix(in srgb, var(--nc-dark-bg), #000 30%);
            display: flex; justify-content: flex-end; gap: 15px;
            border-top: 1px solid color-mix(in srgb, var(--default-color), transparent 90%);
        }

        .popup-actions button {
            border: none; border-radius: 50px; padding: 12px 24px;
            font-size: 1rem; font-weight: 600; font-family: var(--heading-font);
            cursor: pointer; transition: all 0.3s ease;
        }

        #decline-button {
            background-color: transparent; color: var(--default-color);
            border: 2px solid color-mix(in srgb, var(--default-color), transparent 70%);
        }

        #agree-button { background: linear-gradient(135deg, var(--nc-purple), var(--nc-cyan)); color: #ffffff; }
        
        /* Styles for the Captcha View Container */
        .captcha-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
            padding: 30px;
        }
        
        .captcha-view h3 {
            font-family: var(--heading-font); color: var(--heading-color);
            margin-bottom: 25px; font-size: 1.2rem; text-align: center;
        }
    </style>
</head>
<body>

    <div id="legal-popup-overlay" class="popup-hidden">
        <div id="legal-popup">
            <div id="popup-dynamic-area">
                </div>
        </div>
    </div>

    <script>
        // This function will be called by Cloudflare Turnstile upon successful verification
        function onCaptchaVerified(token) {
            const popupOverlay = document.getElementById('legal-popup-overlay');
            console.log("Captcha verified successfully. Token:", token);
            
            localStorage.setItem('noneCloudLegalPoliciesAgreed_v2', 'true');
            
            popupOverlay.style.opacity = '0';
            setTimeout(() => {
                popupOverlay.classList.add('popup-hidden');
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const popupOverlay = document.getElementById('legal-popup-overlay');
            const dynamicArea = document.getElementById('popup-dynamic-area');

            // --- Define the HTML for both views ---
            const legalPromptHTML = `
                <div class="popup-header">
                    <h2>Review Our Legal Policies</h2>
                </div>
                <div class="popup-content">
                    <p>To continue using our services, please review and agree to the updated NoneCloud <a href="/legal.html" target="_blank">Legal Policies</a>.</p>
                </div>
                <div class="popup-actions">
                    <button id="decline-button">Decline</button>
                    <button id="agree-button">I Agree</button>
                </div>
            `;

            const captchaHTML = `
                <div class="captcha-view">
                    <h3>To complete your agreement, please verify your session.</h3>
                    <div class="cf-turnstile" 
                         data-sitekey="1x00000000000000000000AA" 
                         data-callback="onCaptchaVerified"
                         data-theme="dark">
                    </div>
                </div>
            `;

            // --- Function to switch views ---
            function showLegalPrompt() {
                dynamicArea.innerHTML = legalPromptHTML;
                
                // Re-attach event listeners since we are replacing the HTML
                document.getElementById('agree-button').addEventListener('click', showCaptcha);
                document.getElementById('decline-button').addEventListener('click', () => {
                    alert("You must agree to the Legal Policies to use our services. If you do not agree, please close this page.");
                });
            }

            function showCaptcha() {
                // This replaces the entire content of the dynamic area
                dynamicArea.innerHTML = captchaHTML;
                
                // Manually render the Turnstile widget after inserting it into the DOM
                // This is crucial for dynamically loaded captchas
                try {
                    turnstile.render('#popup-dynamic-area .cf-turnstile');
                } catch (e) {
                    console.error("Turnstile render error:", e);
                }
            }

            // --- Initial check on page load ---
            if (localStorage.getItem('noneCloudLegalPoliciesAgreed_v2')) {
                popupOverlay.classList.add('popup-hidden');
            } else {
                showLegalPrompt(); // Load the initial view
                popupOverlay.classList.remove('popup-hidden');
            }
        });
    </script>

</body>
</html>
